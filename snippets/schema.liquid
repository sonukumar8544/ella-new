{% liquid
    assign url = shop.url
    assign page_type = request.page_type
%}
{%- if page_type == 'product' -%}
    {%- liquid
        assign fa_current_variant = product.selected_or_first_available_variant
        assign fa_variant_count = product.variants | size
        assign fa_count = 0
    -%}
  
{% assign original_price1 = product.metafields.custom.price_schema.value %}
{% assign okendo_data = product.metafields.okendo.ProductReviews.value %}
{% assign okendo_reviews = okendo_data.reviews | default: null %}
{% assign featured_image = product.featured_image.src | img_url: 'master' | default: 'https://via.placeholder.com/500' %}

<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.title | strip_html | escape | default: 'Product Name' }}",
  "description": "{{ product.description | strip_html | escape | default: 'Product description' }}",
  "image": "https:{{ featured_image }}",
  "url": "{{ shop.url }}{{ product.url | default: '/' }}",
  {%- if product.variants.first.barcode.size == 12 -%}
    "gtin12": {{ product.variants.first.barcode }},
  {%- elsif product.variants.first.barcode.size == 13 -%}
    "gtin13": {{ product.variants.first.barcode }},
  {%- elsif product.variants.first.barcode.size == 14 -%}
    "gtin14": {{ product.variants.first.barcode }},
  {%- endif -%}
  "sku": "{{ product.variants.first.sku | default: 'SKU-0000' }}",
  "productID": "{{ product.id | default: '0000' }}",
  "brand": {
    "@type": "Thing",
    "name": "{{ product.vendor | escape | default: shop.name }}"
  },
  "offers": {
    "@type": "Offer",
    "priceCurrency": "{{ shop.currency }}",
    "price": "{% for price in original_price1 %}
      {% if localization.country.currency.iso_code == 'USD' and forloop.index0 == 0 %}
        {{ price | default: '0.00' }}
      {% elsif localization.country.currency.iso_code == 'CAD' and forloop.index0 == 1 %}
        {{ price | default: '0.00' }}
      {% endif %}
    {% endfor %}",
    "priceValidUntil": "2025-12-31",
    "availability": "{% if product.available %}http://schema.org/InStock{% else %}http://schema.org/OutOfStock{% endif %}",
    "itemCondition": "https://schema.org/NewCondition",
    "url": "{{ shop.url }}{{ product.url | default: '/' }}",
    "seller": {
      "@type": "Organization",
      "name": "{{ shop.name | escape }}"
    }
  }
  {% if okendo_data and okendo_data.reviewCount > 0 %},
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ okendo_data.averageRating | default: 4.8 | round: 1 }}",
    "ratingCount": "{{ okendo_data.reviewCount | default: 1 }}"
  }
  {% endif %}
  {% if okendo_reviews and okendo_reviews.size > 0 %},
  "review": [
    {% for review in okendo_reviews limit: 3 %}
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "{{ review.reviewer.name | default: 'Verified Buyer' | escape }}"
      },
      "datePublished": "{{ review.createdAt | date: '%Y-%m-%d' | default: '2024-01-01' }}",
      "reviewBody": "{{ review.body | strip_html | escape | default: 'Great product!' }}",
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ review.rating | default: 5 }}",
        "bestRating": "5"
      }
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  {% elsif okendo_data and okendo_data.reviewCount > 0 %},
  "review": [
    {
      "@type": "Review",
      "author": {
        "@type": "Person",
        "name": "Verified Buyer"
      },
      "datePublished": "{{ 'now' | date: '%Y-%m-%d' }}",
      "reviewBody": "This product meets expectations",
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "{{ okendo_data.averageRating | default: 5 | round: 1 }}",
        "bestRating": "5"
      }
    }
  ]
  {% endif %}
}
</script>
  
    <script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ url }}"
        },
        {%- if collection -%}
            {
                "@type": "ListItem",
                "position": 2,
                "name": "{{ collection.title }}",
                "item": "{{ url }}/{{ collection.handle }}"
            },
            {
                "@type": "ListItem",
                "position": 3,
                "name": "{{ product.title }}",
                "item": "{{ canonical_url }}"
            }
        {%- else -%}
            {
                "@type": "ListItem",
                "position": 2,
                "name": "{{ product.title }}",
                "item": "{{ canonical_url }}"
            }
        {%- endif -%}]
    }
    </script>
{%- elsif page_type == 'article' -%}
    <script type="application/ld+json">
        {{ article | structured_data }}
    </script>
    <script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ url }}"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "{{ article.title }}",
            "item": "{{ canonical_url }}"
        }]
    }
    </script>
{%- elsif page_type == 'collection' and collection.handle -%}
    <script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "CollectionPage",
        "name": "{{ collection.title }}",
        "url": "{{ canonical_url }}",
        "description": "{{ collection.description | split: '[lang2]' | first | strip_html }}"
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ url }}"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "{{ collection.title }}",
            "item": "{{ canonical_url }}"
        }]
    }
    </script>
{%- endif -%}